<project name="JBurg3JavaTests" default="cleanBuildAndTest" basedir=".">

    <target name="init">
        <property file="${user.home}/ant.properties" />
        <property file="../..build.properties" />

        <property name="debug.symbols" value="yes"/>

        <property name="jburg.home" value="${user.home}/projects/jburg3"/>
        <property name="lib.dir" value="${jburg.home}/lib" />
        <property name="jburg.jar" value="${lib.dir}/jburg.jar"/>
    
        <property name="src.dir" value="./src" />
        <property name="gensrc.dir" value="./gensrc" />
        <property name="classes.dir" value="./classes" />
        <property name="junit.log.dir" value="./log" />
        <property name="grammar.xml" value="grammars/PoorlyOverloaded.xml"/>
        <property name="testcase.xml" value="testcases/FirstTest.xml"/>
        <property name="stringtemplate.jar" value="${user.home}/tools/antlr-4.5.1-complete.jar"/>
    </target>

    <target name="cleanBuildAndTest" depends="clean,buildJar,compile,allTests"/>

    <target name="clean" depends="init">
        <!-- Remove VIM backup files.  -->
        <delete>
            <fileset dir="${basedir}" includes="**/*.*~" defaultexcludes="no"/>
        </delete>
            
        <delete dir="${classes.dir}" />            
    </target>

    <target name="help">
    <echo>
cleanBuildAndTest - clean, build, and test
allTests - run java tests
    </echo>
    </target>
    
    <target name="buildJar" depends="init">
        <ant dir="${jburg.home}" target="jar"/>
    </target>
	<!-- Compile test articles. -->
	<target name="compile" depends="init"
                        description="Build and compile source files">
		<mkdir dir="${classes.dir}" />

		<javac 
			debug="${debug.symbols}" 
			destdir="${classes.dir}" includes="**/*.java"
			>
            <classpath>
                <pathelement path="${jburg.jar}"/>
            </classpath>
			<src path="${src.dir}"/>
		</javac>
	</target>

    <target name="allTests" depends="init">
        <antcall target="calculator">
            <param name="calculator.xml" value="testcases/FirstTest.xml"/>
        </antcall>
        <antcall target="calculator">
            <param name="calculator.xml" value="testcases/VariadicPatterns.xml"/>
        </antcall>
        <antcall target="dumpLoad">
            <param name="calculator.xml" value="testcases/FirstTest.xml"/>
        </antcall>
    </target>

    <target name="calculator">
        <echo>Testing ${calculator.xml}</echo>
        <java classname="Calculator" fork="true" failonerror="true">
            <arg value="-grammar"/>
            <!-- The default grammar -->
            <arg value="${grammar.xml}"/>
            <arg value="${calculator.xml}"/>
            <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${jburg.jar}"/>
                <pathelement path="${stringtemplate.jar}"/>
            </classpath>
            <jvmarg value="-ea"/>
        </java>
    </target>

    <target name="testGrammar" depends="compile">
        <echo>Testing ${grammar.xml} and ${testcase.xml}</echo>
        <java classname="Calculator" fork="true" failonerror="true">
            <arg value="-grammar"/>
            <arg value="${grammar.xml}"/>
            <arg value="${testcase.xml}"/>
            <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${jburg.jar}"/>
                <pathelement path="${stringtemplate.jar}"/>
            </classpath>
            <jvmarg value="-ea"/>
        </java>
    </target>

    <target name="dumpLoad" depends="compile">
        <echo>Dumping to burmdump/dumpTest.xml</echo>
        <mkdir dir="burmdump"/>
        <java classname="Calculator" fork="true" failonerror="true">
            <arg value="-grammar"/>
            <arg value="${grammar.xml}"/>
            <arg value="-dump"/>
            <arg value="burmdump/dumpTest.xml"/>
            <arg value="${testcase.xml}"/>
            <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${jburg.jar}"/>
                <pathelement path="${stringtemplate.jar}"/>
            </classpath>
            <jvmarg value="-ea"/>
        </java>
        <echo>Loading from burmdump/dumpTest.xml</echo>
        <java classname="Calculator" fork="true" failonerror="true">
            <arg value="-load"/>
            <arg value="burmdump/dumpTest.xml"/>
            <arg value="${testcase.xml}"/>
            <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${jburg.jar}"/>
                <pathelement path="${stringtemplate.jar}"/>
            </classpath>
            <jvmarg value="-ea"/>
        </java>
    </target>

    <target name="loadTest" depends="jar,compile">
        <echo>Loading from ${dump.xml}</echo>
        <java classname="Calculator" fork="true" failonerror="true">
            <arg value="-load"/>
            <arg value="${dump.xml}"/>
            <arg value="${testcase.xml}"/>
            <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${jburg.jar}"/>
                <pathelement path="${stringtemplate.jar}"/>
            </classpath>
            <jvmarg value="-ea"/>
        </java>
    </target>

    <target name="jar">
        <ant dir="../.." target="jar"/>
    </target>

</project>
